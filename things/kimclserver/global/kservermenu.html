<!DOCTYPE html>
<html lang="ko">
<head>
	<title>kserver menu</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="refresh" content="0;/404.html">
</head>
<body>
	<template>
		<style>
			@import "/global/colors/full.css";

			#ks_menu {
				font-size: var(--tiles-1rem, 8.8rem);
			}

			@media screen and (max-width: 480px), screen and (max-width: 30.8rem) {
				#ks_menu {
					font-size: var(--tiles-1rem, calc(100vw / 3.5));
				}
			}

			#ks_button {
				position: fixed;
				font-size: 1em;
				border: none;
				left: 0.05em;
				bottom: 0.05em;
				width: 0.08em;
				height: 0.08em;
				padding: 0;
				border-radius: 0.04em;
				background-color: var(--color);
				cursor: pointer;
				transition: width 0.2s, height 0.2s, background-color 0.2s;
			}

			#ks_button:before {
				content: '';
				position: absolute;
				left: 0;
				bottom: 0;
				width: 0.3em;
				height: 0.3em;
				border-radius: inherit;
			}

			#ks_button:hover, #ks_button:focus {
				width: 0.3em;
				height: 0.3em;
			}

			#ks_button:hover {
				background-color: var(--colorh);
			}

			#ks_button:active {
				background-color: var(--colora);
				transition: width 0.2s, height 0.2s;
			}

			#ks_main {
				position: fixed;
				z-index: 5000;
				left: 0.3em;
				bottom: 0.3em;
				border-radius: 0.15em;
				box-shadow: -0.05em 0.05em 0.05em rgb(from var(--c-black) r g b / 30%),
					-0.1em 0.1em 0.1em rgb(from var(--c-black) r g b / 10%),
					inset -0.05em 0.05em 0.05em rgb(from var(--c-lbg) r g b / 30%);
				transition: opacity 0.2s, display 0.2s, transform 0.2s;
				transition-behavior: allow-discrete;
				background-color: var(--c-gray0);
				opacity: 1;
				display: block;
				@starting-style {
					opacity: 0;
				}
			}

			#ks_main:hover, #ks_main:focus {
				transform: scale(1.02);
			}

			#ks_flex {
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				text-align: center;
				padding: 0.2em;
				color: var(--c-text);
				position: relative;
				z-index: 5002;
			}

			#ks_title {
				margin: 0;
				margin-bottom: 0.2em;
				font-size: 0.286em;
				line-height: 1.1;
			}

			.ks_text {
				opacity: 0.8;
				margin: 0;
				font-size: 0.121em;
				line-height: 1.47059;
			}

			.ks_gap {
				margin: 0;
				margin-bottom: 0.1em;
			}

			.ks_line {
				font-size: 0.121em;
				line-height: 1.47059;
				white-space: nowrap;
			}

			.ks_line > * {
				font-size: 1em;
				vertical-align: middle;
			}

			#ks_main button, #ks_main input {
				display: inline-block;
				font-size: 1em;
			}

			#ks_nurl {
				margin-right: 0.02em;
			}

			#ks_url {
				display: inline-block;
				max-width: 15em;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}

			#ks_url:hover {
				overflow: visible;
			}

			button#ks_hide {
				margin-top: auto;
				padding: 0;
				border: none;
				background: none;
				font-size: 0.121em;
				font-weight: 400;
				line-height: 1.47059;
				cursor: pointer;
			}

			#ks_hide:hover {
				text-decoration: underline;
			}

			#ks_hide.invis {
				visibility: hidden;
			}

			#ks_main.hidden, #ks_main .hidden {
				opacity: 0;
				display: none;
			}
		</style>
		<div id="ks_menu" style="--color: var(--c-w-text); --colorh: var(--c-w-texth); --colora: var(--c-w-texta);">
			<button id="ks_button" type="button" title="서버 연결 상태 보기"></button>
			<div id="ks_main" class="hidden">
				<div id="ks_flex">
					<h2 id="ks_title">서버 연결</h2>
					<p class="ks_text">서버 주소 입력:</p>
					<form id="ks_nurlf" class="ks_line" action="javascript:void(0)">
						<input id="ks_nurl" type="url" placeholder="주소 입력" value="http://localhost:8000" required>
						<input id="ks_nurls" type="submit" value="연결">
					</form>
					<div class="ks_gap"></div>
					<div class="ks_line">
						<span class="ks_text">주소:</span>
						<span id="ks_url"></span>
					</div>
					<div class="ks_line"  style="color: var(--color);">
						<span class="ks_text"><span id="ks_status">연결중</span> · 핑 <span id="ks_ping">---</span></span>
						<button type="submit" id="ks_refresh">새로고침</button>
					</div>
					<div class="ks_gap"></div>
					<h2 id="ks_title">로그인</h2>
					<p class="ks_text" style="max-width: 15em; word-break: keep-all;">
						계정명이 guest로 시작하는 계정은 임시 계정으로, 비밀번호를 아무거나 입력해도 로그인할 수 있습니다.
					</p>
					<form id="ks_loginf" class="ks_line" style="display: flex;" action="javascript:void(0);">
						<div>
							<input id="ks_name" type="text" name="id" placeholder="계정명 입력" required><br>
							<input id="ks_pw" type="password" name="pw" placeholder="비밀번호 입력" required>
						</div>
						<input id="ks_login" type="submit" value="로그인">
					</form>
					<div class="ks_line">
						<span class="ks_text">로그인된 계정:</span>
						<span id="ks_account">[없음]</span>
						<button type="button" id="ks_logout" class="hidden">로그아웃</button>
					</div>
					<button id="ks_hide" class="invis">닫기 ✕</div>
				</div>
			</div>
		</div>
		<script id="script" type="module">
			import { SHA256 } from "/global/sha256.js"

			function $(id, el) { el=el??document; return el.getElementById(id); }
			function $q(q, el) { el=el??document; return el.querySelector(q); }
			function attr(el, at, value) { return value===undefined?el.getAttribute(at):(value===null?el.removeAttribute(at):el.setAttribute(at, value)); }

			let sr = $q("kserver-menu").shadowRoot;

			$("ks_button",sr).onclick = (_) => {
				if (connected || $q('#ks_main.hidden',sr)) $('ks_main',sr).classList.toggle('hidden');
			}
			$("ks_nurlf",sr).onsubmit = changeurl;
			$("ks_refresh",sr).onclick = (_) => { connect(false); };
			$("ks_hide",sr).onclick = (_) => {
				(connected) && $('ks_main',sr).classList.add('hidden');
			}
			$("ks_loginf",sr).onsubmit = login;

			let connected = false;

			function setColor(c) {
				$("ks_menu",sr).style.setProperty('--color',`var(--c-${c}-text)`);
				$("ks_menu",sr).style.setProperty('--colorh',`var(--c-${c}-texth)`);
				$("ks_menu",sr).style.setProperty('--colora',`var(--c-${c}-texta)`);
			}

			function connect(init) {
				let url = localStorage.getItem("server.url");
				$("ks_url",sr).textContent = (!url)?"[없음]":url;
				attr($("ks_url",sr), "title", (!url)?"[없음]":url);
				if (init) {
					setColor("o");
					$("ks_status",sr).textContent = "연결중";
					$("ks_ping",sr).textContent = "---";
					$("ks_hide",sr).classList.add("invis");
				}
				connected = false;
				if (url == null) {
					setColor("w");
					$("ks_status",sr).textContent = "서버 없음";
					$("ks_ping",sr).textContent = "---";
					$("ks_hide",sr).classList.add("invis");
					$('ks_main',sr).classList.remove('hidden');
				} else {
					let start_time = Date.now();
					fetch(`${url}/ping`)
					.then((res) => {
						return res.json();
					}).then((data) => {
						if (data['ecyc'] !== 'e') {
							throw SyntaxError("fail");
						}
						$("ks_status",sr).textContent = "연결됨";
						let ping = Math.round(Date.now() - start_time);
						setColor((ping<=500)?"g":"y");
						$("ks_ping",sr).textContent = `${ping}ms`;
						$("ks_hide",sr).classList.remove("invis");
						connected = true;
					}).catch((e) => {
						// console.error(e);
						setColor("r");
						$("ks_status",sr).textContent = "연결 실패";
						$("ks_ping",sr).textContent = "---";
						$("ks_hide",sr).classList.add("invis");
						$('ks_main',sr).classList.remove('hidden');
					});
				}
			}

			function changeurl() {
				let newurl = $("ks_nurl",sr).value;
				localStorage.setItem("server.url", newurl);
				connect(false);
			}

			function login() {
				fetch(`${localStorage.getItem("server.url")}/login`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify({id: $("ks_name",sr).value, pw: SHA256(`${$("ks_name",sr).value}ecyce${$("ks_pw",sr).value}`)})
				})
				.then((res) => res.json())
				.then((data) => {
					console.log(data);
				}).catch((e) => {
					console.error(e);
				});
			}

			if (localStorage.getItem("server.url")) $("ks_nurl",sr).value = localStorage.getItem("server.url");
			connect(true);
			window.setInterval(connect, 3000);
		</script>
	</template>
</body>
</html>