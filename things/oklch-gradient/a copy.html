<!DOCTYPE html>
<html>
<head>
	<title>OKLab color grid</title>
	<meta charset="utf-8" />
	<style>
		body {
			display:flex; justify-content:center; align-items:center;
			height:100vh; margin:0; background:#111;
		}
		canvas {
			width:600px;
			height: 600px;
			border:1px solid #333;
			display:block;
		}
	</style>
	<script src="/global/kimclmenu.js" defer></script>
</head>
<body>
	<kimcl-menu></kimcl-menu>
	<canvas id="grid"></canvas>
	<script>
		(function() {
			const canvas = document.getElementById("grid");
			const W = 600, H = 600;
			canvas.width = W;
			canvas.height = H;
			const ctx = canvas.getContext("2d");
			const img = ctx.createImageData(W, H);
			const data = img.data;
			
			const L = 0.7; // fixed lightness
			
			// define four corners in OKLab
			const TL = [L, -0.24,  0.24]; // top-left
			const TR = [L,  0.24,  0.24]; // top-right
			const BL = [L, -0.24, -0.24]; // bottom-left
			const BR = [L,  0.24, -0.24]; // bottom-right
			
			function lerp(a, b, t) { return a + (b - a) * t; }
			
			function lerpOklab(c1, c2, t) {
				return [
				lerp(c1[0], c2[0], t),
				lerp(c1[1], c2[1], t),
				lerp(c1[2], c2[2], t)
				];
			}
			
			function oklabToRgb([L, a, b]) {
				// OKLab -> LMS
				const l_ = L + 0.3963377774 * a + 0.2158037573 * b;
				const m_ = L - 0.1055613458 * a - 0.0638541728 * b;
				const s_ = L - 0.0894841775 * a - 1.2914855480 * b;
				
				const l = l_ ** 3;
				const m = m_ ** 3;
				const s = s_ ** 3;
				
				// LMS -> linear sRGB (D65)
				let R = ( 4.0767416621 * l - 3.3077115913 * m + 0.2309699292 * s );
				let G = (-1.2684380046 * l + 2.6097574011 * m - 0.3413193965 * s );
				let B = (-0.0041960863 * l - 0.7034186147 * m + 1.7076147010 * s );
				
				// gamma encode
				return [
				srgbEncode(R),
				srgbEncode(G),
				srgbEncode(B)
				];
			}
			
			function srgbEncode(x) {
				//if (x!=Math.min(1, Math.max(0, x))) return -1;
				x = Math.min(1, Math.max(0, x)); // clamp
				return Math.round(
				255 * (x <= 0.0031308
				? 12.92 * x
				: 1.055 * Math.pow(x, 1/2.4) - 0.055)
				);
			}
			
			// fill image
			for (let y = 0; y < H; y++) {
				const ty = y / (H-1);
				for (let x = 0; x < W; x++) {
					const tx = x / (W-1);
					
					const top = lerpOklab(TL, TR, tx);
					const bot = lerpOklab(BL, BR, tx);
					const mid = lerpOklab(top, bot, ty);
					
					const [r,g,b] = oklabToRgb(mid);
					const idx = (y*W + x) * 4;
					if (r==-1||g==-1||b==-1) continue;
					data[idx]   = r;
					data[idx+1] = g;
					data[idx+2] = b;
					data[idx+3] = 255;
				}
			}
			
			ctx.putImageData(img, 0, 0);
		})();
	</script>
</body>
</html>
